@using Mess.Ozds.Abstractions.Indexes
@using Mess.Iot.Abstractions.Models
@using Mess.Ozds.Abstractions.Models
@using OrchardCore.Users.Models
@using OrchardCore.ContentFields.Indexing.SQL
@using System.Linq.Expressions
@using Mess.Ozds.Abstractions.Timeseries
@using Mess.Billing.Abstractions.Models
@using OrchardCore.ContentManagement.Records
@using OrchardCore.Users.Indexes
@using System.Threading;

@inject IOzdsTimeseriesClient _timeseriesClient

@if(_leftGraphValues is not null){
@* MOBILE *@
   <MudHidden Breakpoint="Breakpoint.MdAndUp">
          <MudPaper Class="d-flex align-center justify-stat mud-width-full pa-1 pb-3 flex-column">
            <MudItem Class="d-flex justify-center align-center" Style="font-size: large; font-weight: bold;">
              @(_leftDataTitle + T[" za"].Value + ": " + Source)
            </MudItem>
            <MudContainer Class="d-flex flex-column" MaxWidth="MaxWidth.Small">
              @if(_leftGraphValues is not null ){
                <ApexChart TItem="ChartDataL"
                  XAxisType="XAxisType.Datetime"
                  Options="graphLOptionsMob"
                  @ref="leftChart">
                    @for(int i = 0; i < leftLineCount ; i++){
                      var j = i;
                      <ApexPointSeries TItem="ChartDataL"
                      Items="@_leftGraphValues"
                      Name="@_leftGraphValues.Select(x => x.names[j]).FirstOrDefault()"
                      SeriesType="SeriesType.Line"
                      XValue='x => DateTimeGraph(x.date)'
                      YValue="x => x.values[j]"
                      Stroke="@(ColorGraph(j))"
                    />
                    }
                    @if(leftLineCount == 0){
                      <ApexPointSeries TItem="ChartDataL"
                      Items="@_leftGraphValues"
                      Name="n/a"
                      SeriesType="SeriesType.Line"
                      XValue='x => DateTimeGraph(x.date)'
                      YValue="x => 0"
                      Stroke="@(ColorGraph(0))"
                    />
                    }
                </ApexChart>
                <MudItem Class="d-flex flex-column justify-center gap-2">
                  <MudMenu Dense="true" Variant="Variant.Filled" Color="MudBlazor.Color.Primary">
                    <ActivatorContent>
                      <MudButton Variant="Variant.Filled" Color="MudBlazor.Color.Primary">
                        @_leftDataTitle
                        <MudIcon Icon="@Icons.Material.Filled.KeyboardArrowDown" />
                      </MudButton>
                    </ActivatorContent>
                    <ChildContent>
                      @foreach(var type in _displayType){
                        <MudMenuItem OnClick="@(() => LeftMenuDataItemClicked(type))">@type</MudMenuItem>
                      }
                    </ChildContent>
                  </MudMenu>
                  <MudMenu Dense="true" Variant="Variant.Filled" Color="MudBlazor.Color.Primary">
                    <ActivatorContent>
                      <MudButton Variant="Variant.Filled" Color="MudBlazor.Color.Primary">
                        @_leftTimeTitle
                        <MudIcon Icon="@Icons.Material.Filled.KeyboardArrowDown" />
                      </MudButton>
                    </ActivatorContent>
                    <ChildContent>
                      <MudMenuItem OnClick="@(() => MenuItemClicked("Scale1"))">15 min</MudMenuItem>
                      <MudMenuItem OnClick="@(() => MenuItemClicked("Scale2"))">1 h</MudMenuItem>
                      <MudMenuItem OnClick="@(() => MenuItemClicked("Scale3"))">6 h</MudMenuItem>
                      <MudMenuItem OnClick="@(() => MenuItemClicked("Scale4"))">24 h</MudMenuItem>
                    </ChildContent>
                  </MudMenu>
                </MudItem>
              }
            </MudContainer>
          </MudPaper>
  </MudHidden>



@* DESKTOP *@
  <MudHidden Breakpoint="Breakpoint.SmAndDown">
          <MudPaper Class="d-flex align-center justify-center mud-width-full py-8 px-8 flex-column" Height="450px">
            <MudItem Class="d-flex justify-center align-center" Style="font-size: large; font-weight: bold;">
              @(_leftDataTitle + " za: " + Source)
            </MudItem>
            <MudContainer Class="d-flex flex-column" MaxWidth="MaxWidth.Medium">
              @if(_leftGraphValues is not null ){
                <ApexChart TItem="ChartDataL"
                  Options="graphLOptions"
                  @ref="leftChart">
                    @for(int i = 0; i < leftLineCount ; i++){
                      var j = i;
                      <ApexPointSeries TItem="ChartDataL"
                      Items="@_leftGraphValues"
                      Name="@_leftGraphValues.Select(x => x.names[j]).FirstOrDefault()"
                      SeriesType="SeriesType.Line"
                      XValue='x => DateTimeGraph(x.date)'
                      YValue="x => x.values[j]"
                      Stroke="@(ColorGraph(j))"
                    />
                    }
                    @if(leftLineCount == 0){
                      <ApexPointSeries TItem="ChartDataL"
                      Items="@_leftGraphValues"
                      Name="n/a"
                      SeriesType="SeriesType.Line"
                      XValue='x => DateTimeGraph(x.date)'
                      YValue="x => 0"
                      Stroke="@(ColorGraph(0))"
                    />
                    }
                </ApexChart>
                <MudItem Class="d-flex flex-row justify-center gap-2">
                  <MudMenu Dense="true" Variant="Variant.Filled" Color="MudBlazor.Color.Primary">
                    <ActivatorContent>
                      <MudButton Variant="Variant.Filled" Color="MudBlazor.Color.Primary">
                        @_leftDataTitle
                        <MudIcon Icon="@Icons.Material.Filled.KeyboardArrowDown" />
                      </MudButton>
                    </ActivatorContent>
                    <ChildContent>
                      @foreach(var type in _displayType){
                        <MudMenuItem OnClick="@(() => LeftMenuDataItemClicked(type))">@type</MudMenuItem>
                      }
                    </ChildContent>
                  </MudMenu>
                  <MudMenu Dense="true" Variant="Variant.Filled" Color="MudBlazor.Color.Primary">
                    <ActivatorContent>
                      <MudButton Variant="Variant.Filled" Color="MudBlazor.Color.Primary">
                        @_leftTimeTitle
                        <MudIcon Icon="@Icons.Material.Filled.KeyboardArrowDown" />
                      </MudButton>
                    </ActivatorContent>
                    <ChildContent>
                      <MudMenuItem OnClick="@(() => MenuItemClicked("Scale1"))">15 min</MudMenuItem>
                      <MudMenuItem OnClick="@(() => MenuItemClicked("Scale2"))">1 h</MudMenuItem>
                      <MudMenuItem OnClick="@(() => MenuItemClicked("Scale3"))">6 h</MudMenuItem>
                      <MudMenuItem OnClick="@(() => MenuItemClicked("Scale4"))">24 h</MudMenuItem>
                    </ChildContent>
                  </MudMenu>
                </MudItem>
              }
            </MudContainer>
          </MudPaper>
  </MudHidden>
}


@code {
    [Parameter]
    public string Source { get; set; } = "abb";
    private ApexChartOptions<ChartDataL> graphLOptions = new();
    private ApexChartOptions<ChartDataL> graphLOptionsMob = new();
    private List<string> _displayType = new List<string>{
      "Napon", "Struja", "Radna snaga", "Jalova snaga", "Prividna snaga"
    };
    public int timeSpanMins = 15;
    public int leftLineCount = 0;
    public int rightLineCount = 0;
    public IEnumerable<ChartDataL>? _leftGraphValues;
    private string _leftDataTitle = "";
    private string _leftTimeTitle = "15 min";
    public record ChartDataL(decimal?[] values, string[] names, DateTimeOffset date, string source);
    private ApexChart<ChartDataL> leftChart = default!;
    protected override async Task OnInitializedAsync()
    {
      graphLOptionsMob= new ApexChartOptions<ChartDataL>() {
        Grid = new Grid
        {
            BorderColor = "#e7e7e7",
            Row = new GridRow
            {
                Colors = new List<string> { "#f3f3f3", "transparent" },
                Opacity = 0.5d
            }
        }
        };
      graphLOptions= new ApexChartOptions<ChartDataL>() {
        Grid = new Grid
        {
            BorderColor = "#e7e7e7",
            Row = new GridRow
            {
                Colors = new List<string> { "#f3f3f3", "transparent" },
                Opacity = 0.5d
            }
        }
        };
      graphLOptions.Chart = new Chart
      {
        Toolbar = new ApexCharts.Toolbar
        {
            Tools = new Tools { Zoomin = true, Zoomout = true, Zoom = false,  Download = false, Pan = true, Selection = false }
        }
      };
      graphLOptions.Tooltip = new ApexCharts.Tooltip { X = new TooltipX { Format = @"HH:mm:ss" } };
      graphLOptionsMob.Tooltip = new ApexCharts.Tooltip { X = new TooltipX { Format = @"HH:mm:ss" } };
      graphLOptionsMob.Yaxis = new List<YAxis>();
      graphLOptions.Yaxis = new List<YAxis>();
      graphLOptionsMob.Xaxis = new XAxis();
      graphLOptions.Xaxis = new XAxis();

      graphLOptionsMob.Yaxis.Add(new YAxis
            {
                Show = false
            });
      graphLOptions.Yaxis.Add(new YAxis()
            {
              Labels = new YAxisLabels(){
                Formatter = "function(val, index) { return val.toFixed(0); }"
                }
            });
      graphLOptionsMob.Xaxis = new XAxis()
            {
              Labels = new XAxisLabels(){ Show = false }
            };
      graphLOptions.Xaxis = new XAxis()
            {
              Type = XAxisType.Datetime,
              AxisTicks = new AxisTicks(){}
            };
      graphLOptionsMob.Chart = new Chart
            {
                Toolbar = new ApexCharts.Toolbar
                {
                    Tools = new Tools { Zoomin = false, Zoomout = false, Download = false, Pan = false, Selection = false}
                }
            };
      await WithTransientSessionAsync(async session => {
        if(Source.StartsWith("abb")){
          var a = await _timeseriesClient.GetAbbMeasurementsAsync(Source, DateTimeOffset.UtcNow.AddMinutes(- timeSpanMins), DateTimeOffset.UtcNow);
          if(_leftGraphValues is null){
            _leftGraphValues = a.Select(x => new ChartDataL(values: new decimal?[]{x.ActivePowerL1_W, x.ActivePowerL2_W, x.ActivePowerL3_W}, names: new string[]{"L1 Radna snaga", "L2 Radna snaga","L3 Radna snaga"}, date:x.Timestamp, source:x.Source)).ToList();
            _displayType = new List<string>{"Napon", "Struja", "Radna snaga", "Jalova snaga"};
            leftLineCount = 3;
            }
        }
        else if(Source.StartsWith("schneider")){
          var a = await _timeseriesClient.GetSchneiderMeasurementsAsync(Source, DateTimeOffset.UtcNow.AddMinutes(- timeSpanMins), DateTimeOffset.UtcNow);
          if(_leftGraphValues is null){
            _leftGraphValues = a.Select(x => new ChartDataL(values: new decimal?[]{x.ActivePowerL1_W, x.ActivePowerL2_W, x.ActivePowerL3_W}, names: new string[]{"L1 Radna snaga", "L2 Radna snaga","L3 Radna snaga"}, date:x.Timestamp, source:x.Source)).ToList();
            _displayType = new List<string>{"Napon", "Struja", "Radna snaga", "Jalova snaga", "Prividna snaga"};
            leftLineCount = 3;
          }
        }
        if(_displayType is not null && _displayType.Count() > 0){
          _leftDataTitle = "Radna snaga";
        }
        else{
          _leftDataTitle = "none";
        }
      });
    }

  private async Task LeftMenuItemClicked(string source)
  {
    if(source.StartsWith("abb")){
      _displayType = new List<string>{"Napon", "Struja", "Radna snaga", "Jalova Snaga"};
      if(_leftDataTitle == "Prividna snaga")
        _leftDataTitle = "Jalova Snaga";
    }
    else if(source.StartsWith("schneider")){
      _displayType = new List<string>{"Napon", "Struja", "Radna snaga", "Jalova Snaga", "Prividna snaga"};
    }
    Source = source;
    await LeftMenuDataItemClicked(_leftDataTitle);
  }

  private async Task GetValues(string source, string type){
    IReadOnlyList<AbbMeasurement>? abbMeasurements = null;
    IReadOnlyList<SchneiderMeasurement>? schneiderMeasurements = null;
    IReadOnlyList<AbbAggregate>? abbAggregate = null;
    IReadOnlyList<SchneiderAggregate>? schneiderAggregate = null;
    if(source.StartsWith("abb")){
      if(timeSpanMins <= 60){
        abbMeasurements = await _timeseriesClient.GetAbbMeasurementsAsync(source, DateTimeOffset.UtcNow.AddMinutes(- timeSpanMins), DateTimeOffset.UtcNow);
      }
      else{
        abbAggregate = await _timeseriesClient.GetAbbQuarterHourlyAggregateAsync(source, DateTimeOffset.UtcNow.AddMinutes(- timeSpanMins), DateTimeOffset.UtcNow);
      }
      _displayType = new List<string>{"Napon", "Struja", "Radna snaga", "Jalova Snaga"};
      if(_leftDataTitle == "Prividna snaga")
        _leftDataTitle = "Jalova Snaga";
    }
    else if(source.StartsWith("schneider")){
      if(timeSpanMins <= 60){
        schneiderMeasurements = await _timeseriesClient.GetSchneiderMeasurementsAsync(source, DateTimeOffset.UtcNow.AddMinutes(- timeSpanMins), DateTimeOffset.UtcNow);
      }
      else{
        schneiderAggregate = await _timeseriesClient.GetSchneiderQuarterHourlyAggregateAsync(source, DateTimeOffset.UtcNow.AddMinutes(- timeSpanMins), DateTimeOffset.UtcNow);
      }
      _displayType = new List<string>{"Napon", "Struja", "Radna snaga", "Jalova Snaga", "Prividna snaga"};
    }
    Source = source;

    switch(type)
    {
      case "Struja":
        if(abbMeasurements is not null){
          _leftGraphValues = abbMeasurements.Select(x => new ChartDataL(values: new decimal?[]{x.CurrentL1_A, x.CurrentL2_A, x.CurrentL3_A}, names: new string[]{"L1 Struja", "L2 Struja","L3 Struja"}, date:x.Timestamp, source:x.Source)).ToList();
          leftLineCount = 3;
        }
        else if(schneiderMeasurements is not null){
          _leftGraphValues = schneiderMeasurements.Select(x => new ChartDataL(values: new decimal?[]{x.CurrentL1_A, x.CurrentL2_A, x.CurrentL3_A}, names: new string[]{"L1 Struja", "L2 Struja","L3 Struja"}, date:x.Timestamp, source:x.Source)).ToList();
          leftLineCount = 3;
        }
        else if(abbAggregate is not null){
          _leftGraphValues = abbAggregate.Select(x => new ChartDataL(values: new decimal?[]{x.CurrentL1Avg_A, x.CurrentL2Avg_A, x.CurrentL3Avg_A}, names: new string[]{"L1 Struja", "L2 Struja","L3 Struja"}, date:x.Timestamp, source:x.Source)).ToList();
          leftLineCount = 3;
        }
        else if(schneiderAggregate is not null){
          _leftGraphValues = schneiderAggregate.Select(x => new ChartDataL(values: new decimal?[]{x.CurrentL1Avg_A, x.CurrentL2Avg_A, x.CurrentL3Avg_A}, names: new string[]{"L1 Struja", "L2 Struja","L3 Struja"}, date:x.Timestamp, source:x.Source)).ToList();
          leftLineCount = 3;
        }
        break;
      case "Radna snaga":
        if(abbMeasurements is not null){
          _leftGraphValues = abbMeasurements.Select(x => new ChartDataL(values: new decimal?[]{x.ActivePowerL1_W, x.ActivePowerL2_W, x.ActivePowerL3_W}, names: new string[]{"L1 Radna snaga", "L2 Radna snaga","L3 Radna snaga"}, date:x.Timestamp, source:x.Source)).ToList();
          leftLineCount = 3;
        }
        else if(schneiderMeasurements is not null){
          _leftGraphValues = schneiderMeasurements.Select(x => new ChartDataL(values: new decimal?[]{x.ActivePowerL1_W, x.ActivePowerL2_W, x.ActivePowerL3_W}, names: new string[]{"L1 Radna snaga", "L2 Radna snaga","L3 Radna snaga"}, date:x.Timestamp, source:x.Source)).ToList();
          leftLineCount = 3;
        }
        else if(abbAggregate is not null){
          _leftGraphValues = abbAggregate.Select(x => new ChartDataL(values: new decimal?[]{x.ActivePowerL1Avg_W, x.ActivePowerL2Avg_W, x.ActivePowerL3Avg_W}, names: new string[]{"L1 Radna snaga", "L2 Radna snaga","L3 Radna snaga"}, date:x.Timestamp, source:x.Source)).ToList();
          leftLineCount = 3;
        }
        else if(schneiderAggregate is not null){
          _leftGraphValues = schneiderAggregate.Select(x => new ChartDataL(values: new decimal?[]{x.ActivePowerL1Avg_W, x.ActivePowerL2Avg_W, x.ActivePowerL3Avg_W}, names: new string[]{"L1 Radna snaga", "L2 Radna snaga","L3 Radna snaga"}, date:x.Timestamp, source:x.Source)).ToList();
          leftLineCount = 3;
        }
        break;
      case "Napon":
        if(abbMeasurements is not null){
          _leftGraphValues = abbMeasurements.Select(x => new ChartDataL(values: new decimal?[]{x.VoltageL1_V, x.VoltageL2_V, x.VoltageL3_V}, names: new string[]{"L1 Napon", "L2 Napon","L3 Napon"}, date:x.Timestamp, source:x.Source)).ToList();
          leftLineCount = 3;
        }
        else if(schneiderMeasurements is not null){
          _leftGraphValues = schneiderMeasurements.Select(x => new ChartDataL(values: new decimal?[]{x.VoltageL1_V, x.VoltageL2_V, x.VoltageL3_V}, names: new string[]{"L1 Napon", "L2 Napon","L3 Napon"}, date:x.Timestamp, source:x.Source)).ToList();
          leftLineCount = 3;
        }
        else if(abbAggregate is not null){
          _leftGraphValues = abbAggregate.Select(x => new ChartDataL(values: new decimal?[]{x.VoltageL1Avg_V, x.VoltageL2Avg_V, x.VoltageL3Avg_V}, names: new string[]{"L1 Napon", "L2 Napon","L3 Napon"}, date:x.Timestamp, source:x.Source)).ToList();
          leftLineCount = 3;
        }
        else if(schneiderAggregate is not null){
          _leftGraphValues = schneiderAggregate.Select(x => new ChartDataL(values: new decimal?[]{x.VoltageL1Avg_V, x.VoltageL2Avg_V, x.VoltageL3Avg_V}, names: new string[]{"L1 Napon", "L2 Napon","L3 Napon"}, date:x.Timestamp, source:x.Source)).ToList();
          leftLineCount = 3;
        }
        break;
      case "Jalova Snaga":
        if(abbMeasurements is not null){
          _leftGraphValues = abbMeasurements.Select(x => new ChartDataL(values: new decimal?[]{x.ReactivePowerL1_VAR, x.ReactivePowerL2_VAR, x.ReactivePowerL3_VAR}, names: new string[]{"L1 Jalova snaga", "L2 Jalova snaga","L3 Jalova snaga"}, date:x.Timestamp, source:x.Source)).ToList();
          leftLineCount = 3;
        }
        else if(schneiderMeasurements is not null){
          _leftGraphValues = schneiderMeasurements.Select(x => new ChartDataL(values: new decimal?[]{x.ReactivePowerTotal_VAR}, names: new string[]{"Jalova snaga"}, date:x.Timestamp, source:x.Source)).ToList();
          leftLineCount = 1;
        }
        else if(abbAggregate is not null){
          _leftGraphValues = abbAggregate.Select(x => new ChartDataL(values: new decimal?[]{x.ReactivePowerL1Avg_VAR, x.ReactivePowerL2Avg_VAR, x.ReactivePowerL3Avg_VAR}, names: new string[]{"L1 Jalova snaga", "L2 Jalova snaga","L3 Jalova snaga"}, date:x.Timestamp, source:x.Source)).ToList();
          leftLineCount = 3;
        }
        else if(schneiderAggregate is not null){
          _leftGraphValues = schneiderAggregate.Select(x => new ChartDataL(values: new decimal?[]{x.ReactivePowerTotalAvg_VAR}, names: new string[]{"Jalova snaga"}, date:x.Timestamp, source:x.Source)).ToList();
          leftLineCount = 1;
        }
        break;
      case "Prividna snaga":
        if(abbMeasurements is not null){
          _leftGraphValues = abbMeasurements.Select(x => new ChartDataL(values: new decimal?[]{}, names: new string[]{}, date:x.Timestamp, source:x.Source)).ToList();
          leftLineCount = 0;
        }
        else if(schneiderMeasurements is not null){
          _leftGraphValues = schneiderMeasurements.Select(x => new ChartDataL(values: new decimal?[]{x.ApparentPowerTotal_VA}, names: new string[]{"Prividna snaga"}, date:x.Timestamp, source:x.Source)).ToList();
          leftLineCount = 1;
        }
        else if(abbAggregate is not null){
          _leftGraphValues = abbAggregate.Select(x => new ChartDataL(values: new decimal?[]{}, names: new string[]{}, date:x.Timestamp, source:x.Source)).ToList();
          leftLineCount = 0;
        }
        else if(schneiderAggregate is not null){
          _leftGraphValues = schneiderAggregate.Select(x => new ChartDataL(values: new decimal?[]{x.ApparentPowerTotalAvg_VA}, names: new string[]{"Prividna snaga"}, date:x.Timestamp, source:x.Source)).ToList();
          leftLineCount = 1;
        }
        break;
      default:
        break;
    }
    StateHasChanged();
    await leftChart.UpdateSeriesAsync(true);
  }
  private async Task LeftMenuDataItemClicked(string type)
  {
    switch(type)
    {
      case "Struja":
        _leftDataTitle = "Struja";
        break;
      case "Radna snaga":
        _leftDataTitle = "Radna snaga";
        break;
      case "Napon":
        _leftDataTitle = "Napon";
        break;
      case "Jalova Snaga":
        if(Source.StartsWith("abb")){
        }
        else if(Source.StartsWith("schneider")){
        }
        _leftDataTitle = "Jalova Snaga";
        break;
      case "Prividna snaga":
        if(Source.StartsWith("abb")){
        }
        else if(Source.StartsWith("schneider")){
        }
        _leftDataTitle = "Prividna snaga";
        break;
      default:
        break;
    }
    await GetValues(Source, _leftDataTitle);
  }
  private async Task MenuItemClicked(string item)
  {
      switch(item)
      {
        case "Scale1":
            timeSpanMins = 15;
            _leftTimeTitle = "15 min";
            break;
        case "Scale2":
            timeSpanMins = 60;
            _leftTimeTitle = "1 h";
            break;
        case "Scale3":
            timeSpanMins = 60 * 6;
            _leftTimeTitle = "6 h";
            break;
        case "Scale4":
            timeSpanMins = 60 * 24;
            _leftTimeTitle = "24 h";
            break;
      }
    await GetValues(Source, _leftDataTitle);
  }
  private ApexCharts.SeriesStroke ColorGraph(int index){
    if(index==0){
        return new ApexCharts.SeriesStroke { Color = "#673AB7", Width = 4};
      }
    if(index==1){
        return new ApexCharts.SeriesStroke { Color = "#FB8C00", Width = 4};
      }
    if(index==2){
        return new ApexCharts.SeriesStroke { Color = "#00897B", Width = 4};
      }
    return new ApexCharts.SeriesStroke { Color = "#FB8C00", Width = 4};
  }
}
