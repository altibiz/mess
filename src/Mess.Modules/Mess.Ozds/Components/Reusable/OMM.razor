@using Mess.Ozds.Abstractions.Indexes
@using Mess.Iot.Abstractions.Models
@using Mess.Ozds.Abstractions.Models
@using OrchardCore.Users.Models
@using OrchardCore.ContentFields.Indexing.SQL
@using System.Linq.Expressions
@using Mess.Ozds.Abstractions.Timeseries
@using Mess.Billing.Abstractions.Models
@using OrchardCore.ContentManagement.Records
@using OrchardCore.Users.Indexes
@using System.Threading;

@inject IOzdsTimeseriesClient _timeseriesClient


@if(_lastDay != null){
@* MOBILE *@
  <MudHidden Breakpoint="Breakpoint.MdAndUp">
    <MudGrid Class="my-3 pa-1">
      <MudItem xs="12" Class="pa-1">
            <MudPaper Class="d-flex align-center justify-stat mud-width-full pa-1 pb-3 flex-column">
              <MudItem Class="d-flex justify-center align-center" Style="font-size: large; font-weight: bold;">
                @(T["Snaga po fazi za"].Value + ": " + Source)
              </MudItem>
        <MudContainer Class="d-flex flex-column" MaxWidth="MaxWidth.Small">
                <ApexChart TItem="ChartData"
                  XAxisType="XAxisType.Datetime"
                  Options="graphOptionsMobile"
                  @ref="chart">
                  <ApexPointSeries TItem="ChartData"
                    Items="@_graphValues"
                    Name="@T["L1 Potrošnja"].Value"
                    SeriesType="SeriesType.Line"
                    XValue='x => x.date'
                    YValue="x => x.L1"
                  />
                  <ApexPointSeries TItem="ChartData"
                    Items="@_graphValues"
                    Name="@T["L2 Potrošnja"].Value"
                    SeriesType="SeriesType.Line"
                    XValue='x => x.date'
                    YValue="x => x.L2"
                  />
                  <ApexPointSeries TItem="ChartData"
                    Items="@_graphValues"
                    Name="@T["L3 Potrošnja"].Value"
                    SeriesType="SeriesType.Line"
                    XValue='x => x.date'
                    YValue="x => x.L3"
                  />
                </ApexChart>
        <MudMenu Label="@T["Odabir vremena"].Value" Dense="true" Variant="Variant.Filled" Color="MudBlazor.Color.Primary">
          <MudMenuItem OnClick="@(() => MenuItemClicked("Scale1"))">5 min</MudMenuItem>
          <MudMenuItem OnClick="@(() => MenuItemClicked("Scale2"))">10 min</MudMenuItem>
          <MudMenuItem OnClick="@(() => MenuItemClicked("Scale3"))">15 min</MudMenuItem>
          <MudMenuItem OnClick="@(() => MenuItemClicked("Scale4"))">30 min</MudMenuItem>
        </MudMenu>
        </MudContainer>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" Class="pa-1">
            <MudPaper Class="d-flex align-center justify-start mud-width-full pa-1 flex-column">
              <MudItem Class="d-flex justify-center align-center" Style="font-size: large; font-weight: bold;">
                @(T["Potrošnja od"].Value + ": " + Source)
              </MudItem>
        <MudContainer MaxWidth="MaxWidth.Small">
                <ApexChart TItem="Order"
                          Options="options"
                          >
                    <ApexPointSeries TItem="Order"
                                    Items="orders"
                                    SeriesType=SeriesType.RadialBar
                                    Name="@T["Potrošnja"].Value"
                                    XValue="@(e => e.value)"
                                    YAggregate="@(e => e.First().percent)"
                                    OrderByDescending="e=>e.X" />
                </ApexChart>
        </MudContainer>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudPaper Class="pa-1">
      <MudText Typo="Typo.h4" Class="d-flex justify-center">
        @(T["Brojilo"].Value + ": " + Source)
      </MudText>
      <MudDivider />
      @foreach(ExpandThing dataStruct in _shownOMMs.Where(x => x.show == true).ToList()){
      <MudPaper Elevation="2" Class="ma-1">
        <MudStack Spacing="0">
          <MudGrid Class="d-flex pa-2">
            <MudItem xs="5" Class="d-flex align-center justify-start" Style="font-weight: bold;">
              @T["Godina"].Value: @dataStruct.data.year
            </MudItem>
            <MudItem xs="5" Class="d-flex align-center justify-start" Style="font-weight: bold;">
              @T["Mjesec"].Value: @dataStruct.data.month
            </MudItem>
            <MudItem xs="2" Class="d-flex align-center justify-end">
              <MudIconButton OnClick="() => OnExpandCollapseClick(dataStruct.data.year, dataStruct.data.month)" Icon="@(dataStruct.expand ? Icons.Material.Filled.KeyboardArrowUp : Icons.Material.Filled.KeyboardArrowDown)" Color="MudBlazor.Color.Default"/>
            </MudItem>
          </MudGrid>
          <MudCollapse Class="py-1" Expanded="_shownOMMs.Where(x => x.data.year == dataStruct.data.year).Where(x => x.data.month == dataStruct.data.month).First().expand">
            <MudStack>
              <MudDivider DividerType="DividerType.Middle" Class="mt-2"/>
              <MudContainer>
                @T["Poćetna potrošnja"].Value: @(dataStruct.data.monthEndTotal) kWh
              </MudContainer>
              <MudContainer>
                @T["Zadnja potrošnja"].Value: @(dataStruct.data.monthStartTotal) kWh
              </MudContainer>
              <MudContainer Style="font-size: large; font-weight:bold;">
                @T["Ukupna potrošnja"].Value: @(dataStruct.data.monthStartTotal - dataStruct.data.monthEndTotal) kWh
              </MudContainer>
            </MudStack>
          </MudCollapse>
        </MudStack>
      </MudPaper>
      }
    </MudPaper>
  </MudHidden>



@* DESKTOP *@
  <MudHidden Breakpoint="Breakpoint.SmAndDown">
<MudDataGrid
  T="TabularData"
  MultiSelection="true"
  Items="@_dataStruct"
  SortMode="SortMode.Multiple">
  <ToolBarContent>
    <MudText Typo="Typo.h4">@(T["Brojilo"].Value + ": " + Source)</MudText>
    <MudSpacer />
    <MudTextField
      @bind-Value="_searchString"
      Placeholder="@T["Pretraži"].Value"
      Adornment="Adornment.Start"
      Immediate="true"
      AdornmentIcon="@Icons.Material.Filled.Search"
      IconSize="MudBlazor.Size.Medium"
      Class="mt-0">
    </MudTextField>
  </ToolBarContent>
  <Columns>
    <PropertyColumn
      CellStyle="font-size: large;"
      Property="x => x.year"
      Title='@T["Godina"].Value'/>
    <PropertyColumn
      Property="x => x.month"
      Title='@T["Mjesec"].Value' />
    <PropertyColumn
      CellStyle="font-size: x-large;"
      Property="x => x.monthEndTotal"
      Title='@T["Poćetna potrošnja"].Value'
      Sortable="false"
      Filterable="false"/>
    <PropertyColumn
      CellStyle="font-size: x-large;"
      Property="x => x.monthStartTotal"
      Title='@T["Zadnja potrošnja"].Value'
      Sortable="false"
      Filterable="false"/>
    <PropertyColumn
      CellStyle="font-size: xx-large;"
      Property="x => x.monthStartTotal - x.monthEndTotal"
      Title='@T["Ukupna potrošnja"].Value'/>
  </Columns>
  <PagerContent>
    <MudDataGridPager T="TabularData" />
  </PagerContent>
</MudDataGrid>

    <MudGrid Class="my-3">
        <MudItem xs="6">
            <MudPaper Class="d-flex align-center justify-start mud-width-full py-8 px-8 flex-column" Height="450px">
              <MudItem Class="d-flex" Style="font-size: large; font-weight: bold;">
                @(T["Potrošnja od"].Value + ": " + Source)
              </MudItem>
        <MudContainer MaxWidth="MaxWidth.Small">
                <ApexChart TItem="Order"
                          Options="options"
                          >
                    <ApexPointSeries TItem="Order"
                                    Items="orders"
                                    SeriesType=SeriesType.RadialBar
                                    Name="@T["Potrošnja"].Value"
                                    XValue="@(e => e.value)"
                                    YAggregate="@(e => e.First().percent)"
                                    OrderByDescending="e=>e.X" />
                </ApexChart>
        </MudContainer>
            </MudPaper>
        </MudItem>
        <MudItem xs="6">
            <MudPaper Class="d-flex align-center justify-stat mud-width-full py-8 px-8 flex-column" Height="450px">
              <MudItem Class="d-flex" Style="font-size: large; font-weight: bold;">
                @(T["Snaga po fazi za"].Value + ": " + Source)
              </MudItem>
        <MudContainer Class="d-flex flex-column" MaxWidth="MaxWidth.Small">
                <ApexChart TItem="ChartData"
                  XAxisType="XAxisType.Datetime"
                  Options="graphOptions"
                  @ref="chart">
                  <ApexPointSeries TItem="ChartData"
                    Items="@_graphValues"
                    Name="@T["L1 Potrošnja"].Value"
                    SeriesType="SeriesType.Line"
                    XValue='x => x.date'
                    YValue="x => x.L1"
                  />
                  <ApexPointSeries TItem="ChartData"
                    Items="@_graphValues"
                    Name="@T["L2 Potrošnja"].Value"
                    SeriesType="SeriesType.Line"
                    XValue='x => x.date'
                    YValue="x => x.L2"
                  />
                  <ApexPointSeries TItem="ChartData"
                    Items="@_graphValues"
                    Name="@T["L3 Potrošnja"].Value"
                    SeriesType="SeriesType.Line"
                    XValue='x => x.date'
                    YValue="x => x.L3"
                  />
                </ApexChart>
        <MudMenu Label="@T["Odabir vremena"].Value" Dense="true" Variant="Variant.Filled" Color="MudBlazor.Color.Primary">
          <MudMenuItem OnClick="@(() => MenuItemClicked("Scale1"))">5 min</MudMenuItem>
          <MudMenuItem OnClick="@(() => MenuItemClicked("Scale2"))">10 min</MudMenuItem>
          <MudMenuItem OnClick="@(() => MenuItemClicked("Scale3"))">15 min</MudMenuItem>
          <MudMenuItem OnClick="@(() => MenuItemClicked("Scale4"))">30 min</MudMenuItem>
          <MudMenuItem OnClick="@(() => MenuItemClicked("Scale5"))">1 h</MudMenuItem>
          <MudMenuItem OnClick="@(() => MenuItemClicked("Scale6"))">3 h</MudMenuItem>
          <MudMenuItem OnClick="@(() => MenuItemClicked("Scale7"))">6 h</MudMenuItem>
          <MudMenuItem OnClick="@(() => MenuItemClicked("Scale8"))">12 h</MudMenuItem>
          <MudMenuItem OnClick="@(() => MenuItemClicked("Scale9"))">24 h</MudMenuItem>
        </MudMenu>
        </MudContainer>
            </MudPaper>
        </MudItem>
    </MudGrid>
  </MudHidden>
}

@code {

    [Parameter]
    public string Source { get; set; } = "abb";
    public string TextValue { get; set; } = "";
    private List<Order> orders = new List<Order>();
    private ApexChartOptions<Order> options = new();
    private ApexChartOptions<ChartData> graphOptions = new();
    private ApexChartOptions<ChartData> graphOptionsMobile = new();
    private string? _searchString;
    private List<TabularData> _dataStruct = new List<TabularData>();
    public IEnumerable<ChartData>? _lastDay;
    public IEnumerable<ChartData>? _graphValues;
    private (decimal? First, decimal? Last, DateTimeOffset FirstDate) _startEnd;
    public record ChartData(decimal? L1, decimal? L2, decimal? L3, DateTimeOffset date);
    public record struct TabularData(int year, int month, decimal? monthStartTotal, decimal? monthEndTotal);
    private int _month = -1;
    private int _year = -1;
    private ApexChart<ChartData> chart = default!;
    private Timer? timer;
    private bool timerInitialized;
  private class Order {
    public decimal? value = 10;
    public decimal? valueMax = 100000;
    public decimal? percent = 50;

    public Order(decimal? val){
      value = val;
      percent = (value / valueMax) * 100;
    }
  }
    private class ExpandThing {
      public TabularData data;
      public bool expand;
      public bool show;
    }
    List<ExpandThing> _shownOMMs = new();
    protected override void OnAfterRender(bool firstRender)
    {
        // if (firstRender && !timerInitialized)
        // {
        //     timerInitialized = true;
        //     timer = new Timer(
        //       new TimerCallback(async _ => await GetValues()),
        //       null,
        //       0,
        //       10000
        //     );
        // }
    }
    protected override async Task OnInitializedAsync()
    {
      graphOptions= new ApexChartOptions<ChartData>() {
        Grid = new Grid
        {
            BorderColor = "#e7e7e7",
            Row = new GridRow
            {
                Colors = new List<string> { "#f3f3f3", "transparent" },
                Opacity = 0.5d
            }
        }
        };
      graphOptionsMobile= new () {
      Grid = new Grid
      {
          BorderColor = "#e7e7e7",
          Row = new GridRow
          {
              Colors = new List<string> { "#f3f3f3", "transparent" },
              Opacity = 0.5d
          }
      }
      };
      graphOptions.Tooltip = new ApexCharts.Tooltip { X = new TooltipX { Format = @"hh : mm : ss" } };
      graphOptionsMobile.Tooltip = new () { X = new TooltipX { Format = @"hh : mm : ss" } };
      graphOptionsMobile.Yaxis = new List<YAxis>();
      graphOptionsMobile.Xaxis = new XAxis();

      graphOptionsMobile.Yaxis.Add(new YAxis
            {
                Show = false
            });
      graphOptionsMobile.Xaxis = new XAxis()
            {
              Labels = new XAxisLabels(){ Show = false }
            };
      graphOptionsMobile.Chart = new Chart
            {
                Toolbar = new ApexCharts.Toolbar
                {
                    Tools = new Tools { Zoomin = false, Zoomout = false, Download = false, Pan = false, Reset = false, Selection = false, Zoom = false, }
                }
            };
      options.PlotOptions = new PlotOptions { RadialBar = new PlotOptionsRadialBar { StartAngle = -90, EndAngle = 90 } };
      if(Source.StartsWith("abb"))
        _startEnd = await _timeseriesClient.GetAbbLastMonthMeasurementsAsync(Source);
      else
        _startEnd = await _timeseriesClient.GetSchneiderLastMonthMeasurementsAsync(Source);

      if(_startEnd.First != null && _startEnd.Last != null){
        _month = _startEnd.FirstDate.Month;
        _year = _startEnd.FirstDate.Year;
        _dataStruct.Add(new TabularData(_year, _month, _startEnd.First, _startEnd.Last));
        _shownOMMs.Add(new ExpandThing{data = new (_year, _month, _startEnd.First, _startEnd.Last), show = true, expand = false});
      }
      if(Source.StartsWith("abb")){
        var a = await _timeseriesClient.GetAbbMeasurementsAsync(Source, DateTimeOffset.UtcNow.AddMinutes(-1), DateTimeOffset.UtcNow);
        _lastDay = a.Select(x => new ChartData(x.ActivePowerL1_W, x.ActivePowerL2_W, x.ActivePowerL3_W, x.Timestamp)).ToList();
      }
      else{
        var a = await _timeseriesClient.GetSchneiderMeasurementsAsync(Source, DateTimeOffset.UtcNow.AddMinutes(-1), DateTimeOffset.UtcNow);
        _lastDay = a.Select(x => new ChartData(x.ActivePowerL1_W, x.ActivePowerL2_W, x.ActivePowerL3_W, x.Timestamp)).ToList();
      }
      _graphValues = _lastDay.TakeLast(20);
      orders.Add(new Order(_startEnd.First));
    }

  private async Task MenuItemClicked(string item)
  {
    switch(item)
    {
      case "Scale1":
          _graphValues = _lastDay.Where(x => x.date > DateTime.UtcNow.AddMinutes(-5));
          break;
      case "Scale2":
          _graphValues =_lastDay.Where(x => x.date > DateTime.UtcNow.AddMinutes(-10));;
          break;
      case "Scale3":
          _graphValues =_lastDay.Where(x => x.date > DateTime.UtcNow.AddMinutes(-15));;
          break;
      case "Scale4":
          _graphValues =_lastDay.Where(x => x.date > DateTime.UtcNow.AddMinutes(-30));;
          break;
    }
    await chart.UpdateSeriesAsync(true);
  }

  private async Task GetValues(){
    if(Source.StartsWith("abb")){
        var a = await _timeseriesClient.GetAbbMeasurementsAsync(Source, DateTimeOffset.UtcNow.AddMinutes(-1), DateTimeOffset.UtcNow);
        _lastDay = a.Select(x => new ChartData(x.ActivePowerL1_W, x.ActivePowerL2_W, x.ActivePowerL3_W, x.Timestamp)).ToList();
      }
      else{
        var a = await _timeseriesClient.GetSchneiderMeasurementsAsync(Source, DateTimeOffset.UtcNow.AddMinutes(-1), DateTimeOffset.UtcNow);
        _lastDay = a.Select(x => new ChartData(x.ActivePowerL1_W, x.ActivePowerL2_W, x.ActivePowerL3_W, x.Timestamp)).ToList();
      }
    _graphValues = _lastDay.TakeLast(20);
    await chart.UpdateSeriesAsync(true);
  }
  private void OnExpandCollapseClick(int year, int month) {
      var a = _shownOMMs.Where(x => x.data.year == year).Where(x => x.data.month == month).FirstOrDefault();
      a.expand = !a.expand;
  }
}
